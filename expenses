#!/usr/bin/python
from datetime import date
import sys
import os
from collections import defaultdict
from mercurial import ui, hg, commands

VERSION="0.1"

HOME = os.getenv("HOME")
EXPENSES_DIR = os.path.join(HOME, ".expenses")
REPO_DIR = os.path.join(EXPENSES_DIR, 'repo')
EXPENSES_FILE=os.path.join(REPO_DIR, "expenses.csv")

EDITOR=os.getenv("EDITOR")
if not EDITOR:
    EDITOR = "vim"


def print_usage():
    print "\n".join(["USAGE: {0} add AMOUNT COMMENT".format(sys.argv[0]),
                    "       {0} list".format(sys.argv[0]),
                    "       {0} plot".format(sys.argv[0]),
                    "       {0} summary".format(sys.argv[0])
                    ])

class Entry(object):
    def __init__(self, s):
        d, amt, msg = s.split(',')
        self.date = date(*[int(n) for n in d.split("-")])
        self.amount = float(amt)
        self.message = msg
        
def parse_entries(f):
    try:
        return [Entry(line) for i, line in enumerate(f)]
    except ValueError:
        print "Invalid expenses file, line:{0}".format(i+1)
        print line
        return None
        
def add(args):
    try:
        amt = float(args[0])
    except ValueError, e:
        print "Amount not recognized"
        return False
    msg = args[1]
    with open(EXPENSES_FILE, 'a') as f:
        f.write("{0}, {1:.2f}, {2}\n".format(date.today().isoformat(), amt, msg))
    return True

def fn_list(args):
    for line in open(EXPENSES_FILE):
        print line,
    return True

def edit(args):
    os.system("{0} {1}".format(EDITOR, EXPENSES_FILE))
    return True

def summary(args):
    entries = parse_entries(open(EXPENSES_FILE))
    if not entries:
        return False
    from_date = min(entry.date for entry in entries)
    to_date = max(entry.date for entry in entries)
    total_spent = sum(entry.amount for entry in entries)
    average_all = total_spent/((to_date-from_date).days + 1)
    spentdays = set(entry.date for entry in entries)
    # Average over days where some money was spent
    average_some = total_spent/len(spentdays)
    print "Report from {0} to {1}".format(from_date, to_date)
    print "Total spent: ${0:.2f}".format(total_spent)
    print "Average per day: ${0:.2f} (*30 = ${1:.2f})".format(average_all, average_all*30)
    print "Average per day on days with non-zero spending: ${0:.2f} (*30 = ${1:.2f})".format(average_some, average_some*30)
    return True
    

def plot(args):
    import matplotlib.pyplot as plt
    import matplotlib.dates as mdates
    dayLocator = mdates.DayLocator()
    formatter = mdates.DateFormatter('%Y-%m-%d')
    dates = defaultdict(float)
    entries = parse_entries(open(EXPENSES_FILE))
    if not entries:
        return False

    for entry in entries:
        dates[entry.date] += entry.amount

    fig = plt.figure()
    ax = fig.add_subplot(111)
    ax.bar([k for k in sorted(dates.keys())],
        [dates[k] for k in sorted(dates.keys())],
        color="#809860")
    ax.xaxis.set_major_locator(dayLocator)
    ax.xaxis.set_major_formatter(formatter)
    fig.autofmt_xdate()
    
    plt.show()
    return True
    #plt.plot((date(*k.split("-")) for k in sorted(dates.keys())),

######################################################################
# Initialization stuff                                               #
######################################################################
def init_dir():
    """Initialize the .expenses directory, and the mercurial repository"""
    try:
        os.mkdir(EXPENSES_DIR)
        os.mkdir(REPO_DIR)
    except OSError, e:
        print e
        return False
    with open(EXPENSES_FILE, 'w') as f:
        f.write("# Version: {0}\n".format(VERSION))
    repo = hg.repository(ui.ui(), REPO_DIR, create=True)
    commands.commit(ui.ui(), repo, EXPENSES_FILE, message="Initialized new expenses file", addremove=True)
    return True

def load_repo():
    """ Load the mercurial repository into the global repo variable """
    global repo
    repo = hg.repository(ui.ui(), REPO_DIR)

def main():
    # If the .expenses folder does not exist, create it.
    if not os.path.isdir(EXPENSES_DIR):
        if not init_dir(): return 1

    load_repo()

    if len(sys.argv) == 1:
        print_usage()
        return 1
    fn = cmds.get(sys.argv[1])
    if fn == None:
        print_usage()
        return 1
    if not fn(sys.argv[2:]):
        print_usage()
        return 1
    return 0

cmds = {"add": add, "list": fn_list, "edit": edit, "plot": plot, "summary": summary}

if __name__ == "__main__":
    sys.exit(main())
